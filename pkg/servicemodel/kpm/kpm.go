// SPDX-FileCopyrightText: 2020-present Open Networking Foundation <info@opennetworking.org>
//
// SPDX-License-Identifier: LicenseRef-ONF-Member-1.0

package kpm

import (
	"context"
	"time"

	indicationutils "github.com/onosproject/ran-simulator/pkg/utils/indication"

	subutils "github.com/onosproject/ran-simulator/pkg/utils/subscription"

	"github.com/onosproject/onos-lib-go/pkg/logging"

	"github.com/onosproject/onos-e2t/pkg/protocols/e2"
	"github.com/onosproject/ran-simulator/pkg/servicemodel/registry"

	"github.com/onosproject/onos-e2t/api/e2ap/v1beta1/e2apies"
	"github.com/onosproject/onos-e2t/api/e2ap/v1beta1/e2appducontents"
	"github.com/onosproject/onos-e2t/pkg/southbound/e2ap/types"
	"github.com/onosproject/ran-simulator/pkg/servicemodel"
)

var _ servicemodel.ServiceModel = &ServiceModel{}

var log = logging.GetLogger("sm", "kpm")

// ServiceModel kpm service model struct
type ServiceModel struct {
	Channel e2.ClientChannel
}

// GetConfig returns service model config information
func GetConfig() registry.ServiceModelConfig {
	kpmSm := registry.ServiceModelConfig{
		ID:           registry.Kpm,
		ServiceModel: &ServiceModel{},
		Revision:     1,
	}

	// TODO: Generate ASN1 bytes on the fly - can only be done through plugin
	kpmSm.Description = ranFuncDescBytes

	return kpmSm
}

func (sm *ServiceModel) reportIndication(ctx context.Context, interval time.Duration, subscription *subutils.Subscription) {

	// TODO indication header and indication message should be generated using model plugins
	indication, _ := indicationutils.NewIndication(
		indicationutils.WithRicInstanceID(subscription.GetRicInstanceID()),
		indicationutils.WithRanFuncID(subscription.GetRanFuncID()),
		indicationutils.WithRequestID(subscription.GetReqID()),
		indicationutils.WithIndicationHeader(indicationHeaderBytes),
		indicationutils.WithIndicationMessage(indicationMessageBytes))

	ricIndication := indicationutils.CreateIndication(indication)

	ticker := time.NewTicker(interval * time.Second)
	for range ticker.C {
		log.Info("Sending indication")
		err := sm.Channel.RICIndication(ctx, ricIndication)
		if err != nil {
			log.Error("Sending indication report is failed:", err)
			break
		}
	}

}

// RICControl implements control handler for kpm service model
func (sm *ServiceModel) RICControl(ctx context.Context, request *e2appducontents.RiccontrolRequest) (response *e2appducontents.RiccontrolAcknowledge, failure *e2appducontents.RiccontrolFailure, err error) {
	panic("implement me")

}

// RICSubscription implements subscription handler for kpm service model
func (sm *ServiceModel) RICSubscription(ctx context.Context, request *e2appducontents.RicsubscriptionRequest) (response *e2appducontents.RicsubscriptionResponse, failure *e2appducontents.RicsubscriptionFailure, err error) {

	var ricActionsAccepted []*types.RicActionID
	var ricActionsNotAdmitted map[types.RicActionID]*e2apies.Cause
	actionList := request.ProtocolIes.E2ApProtocolIes30.Value.RicActionToBeSetupList.Value

	reqID := request.ProtocolIes.E2ApProtocolIes29.Value.RicRequestorId
	ranFuncID := request.ProtocolIes.E2ApProtocolIes5.Value.Value
	ricInstanceID := request.ProtocolIes.E2ApProtocolIes29.Value.RicInstanceId

	for _, action := range actionList {
		actionID := types.RicActionID(action.Value.RicActionId.Value)
		actionType := action.Value.RicActionType
		if actionType == e2apies.RicactionType_RICACTION_TYPE_REPORT {
			ricActionsAccepted = append(ricActionsAccepted, &actionID)
		}
		// TODO handle not admitted actions
	}
	subscription, _ := subutils.NewSubscription(
		subutils.WithRequestID(reqID),
		subutils.WithRanFuncID(ranFuncID),
		subutils.WithRicInstanceID(ricInstanceID),
		subutils.WithActionsAccepted(ricActionsAccepted),
		subutils.WithActionsNotAdmitted(ricActionsNotAdmitted))

	// At least one required action must be accepted otherwise sends a subscription failure response
	if len(ricActionsAccepted) == 0 {
		subscriptionFailure := subutils.CreateSubscriptionFailure(subscription)
		return nil, subscriptionFailure, nil
	}

	// TODO handle event trigger definitions

	subscriptionResponse := subutils.CreateSubscriptionResponse(subscription)
	go sm.reportIndication(ctx, 1, subscription)
	return subscriptionResponse, nil, nil

}

// RICSubscriptionDelete implements subscription delete handler for kpm service model
func (sm *ServiceModel) RICSubscriptionDelete(ctx context.Context, request *e2appducontents.RicsubscriptionDeleteRequest) (response *e2appducontents.RicsubscriptionDeleteResponse, failure *e2appducontents.RicsubscriptionDeleteFailure, err error) {
	panic("implement me")
}

// FROM tests
//var indicationMessageBytes = []byte{0x40, 0x00, 0x00, 0x4B, 0x01, 0x00}

var indicationMessageBytes = []byte{0x18, 0x24, 0x10, 0x22, 0x10, 0x18, 0x18, 0x16, 0x10, 0x10, 0x10, 0x08, 0x66, 0x6F, 0x45, 0x67, 0x78, 0x66, 0x00, 0x18, 0x02, 0x08, 0x01, 0x18, 0x00}

// FROM tests
//var indicationHeaderBytes = []byte{0x3F, 0x08, 0x37, 0x34, 0x37, 0x38, 0xB5, 0xC6, 0x77, 0x88, 0x02, 0x37, 0x34, 0x37, 0x22, 0x5B,
//	0xD6, 0x00, 0x70, 0x37, 0x34, 0x37, 0x98, 0x80, 0x31, 0x30, 0x30, 0x09, 0x09}

var indicationHeaderBytes = []byte{0x10, 0x23, 0x10, 0x21, 0x34, 0x19, 0x10, 0x17, 0x10, 0x05, 0x10, 0x03, 0x00, 0x02, 0x16, 0x18, 0x08, 0x10, 0x06, 0x08, 0x80, 0xC0, 0x03, 0x16, 0x20}

var ranFuncDescBytes = []byte{
	0x20, 0xC0, 0x4F, 0x52, 0x41, 0x4E, 0x2D, 0x45, 0x32, 0x53, 0x4D, 0x2D, 0x4B, 0x50, 0x4D, 0x00, 0x00, 0x05, 0x4F, 0x49,
	0x44, 0x31, 0x32, 0x33, 0x05, 0x00, 0x4B, 0x50, 0x4D, 0x20, 0x6D, 0x6F, 0x6E, 0x69, 0x74, 0x6F, 0x72, 0x08, 0x93, 0x49,
	0xF4, 0x77, 0xF9, 0xE1, 0xAF, 0x00, 0x60, 0x00, 0x01, 0x01, 0x07, 0x00, 0x50, 0x65, 0x72, 0x69, 0x6F, 0x64, 0x69, 0x63,
	0x20, 0x72, 0x65, 0x70, 0x6F, 0x72, 0x74, 0x01, 0x05, 0x14, 0x01, 0x01, 0x1D, 0x00, 0x4F, 0x2D, 0x44, 0x55, 0x20, 0x4D,
	0x65, 0x61, 0x73, 0x75, 0x72, 0x65, 0x6D, 0x65, 0x6E, 0x74, 0x20, 0x43, 0x6F, 0x6E, 0x74, 0x61, 0x69, 0x6E, 0x65, 0x72,
	0x20, 0x66, 0x6F, 0x72, 0x20, 0x74, 0x68, 0x65, 0x20, 0x35, 0x47, 0x43, 0x20, 0x63, 0x6F, 0x6E, 0x6E, 0x65, 0x63, 0x74,
	0x65, 0x64, 0x20, 0x64, 0x65, 0x70, 0x6C, 0x6F, 0x79, 0x6D, 0x65, 0x6E, 0x74, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x02,
	0x1D, 0x00, 0x4F, 0x2D, 0x44, 0x55, 0x20, 0x4D, 0x65, 0x61, 0x73, 0x75, 0x72, 0x65, 0x6D, 0x65, 0x6E, 0x74, 0x20, 0x43,
	0x6F, 0x6E, 0x74, 0x61, 0x69, 0x6E, 0x65, 0x72, 0x20, 0x66, 0x6F, 0x72, 0x20, 0x74, 0x68, 0x65, 0x20, 0x45, 0x50, 0x43,
	0x20, 0x63, 0x6F, 0x6E, 0x6E, 0x65, 0x63, 0x74, 0x65, 0x64, 0x20, 0x64, 0x65, 0x70, 0x6C, 0x6F, 0x79, 0x6D, 0x65, 0x6E,
	0x74, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x03, 0x1E, 0x80, 0x4F, 0x2D, 0x43, 0x55, 0x2D, 0x43, 0x50, 0x20, 0x4D, 0x65,
	0x61, 0x73, 0x75, 0x72, 0x65, 0x6D, 0x65, 0x6E, 0x74, 0x20, 0x43, 0x6F, 0x6E, 0x74, 0x61, 0x69, 0x6E, 0x65, 0x72, 0x20,
	0x66, 0x6F, 0x72, 0x20, 0x74, 0x68, 0x65, 0x20, 0x35, 0x47, 0x43, 0x20, 0x63, 0x6F, 0x6E, 0x6E, 0x65, 0x63, 0x74, 0x65,
	0x64, 0x20, 0x64, 0x65, 0x70, 0x6C, 0x6F, 0x79, 0x6D, 0x65, 0x6E, 0x74, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x04, 0x1E,
	0x80, 0x4F, 0x2D, 0x43, 0x55, 0x2D, 0x43, 0x50, 0x20, 0x4D, 0x65, 0x61, 0x73, 0x75, 0x72, 0x65, 0x6D, 0x65, 0x6E, 0x74,
	0x20, 0x43, 0x6F, 0x6E, 0x74, 0x61, 0x69, 0x6E, 0x65, 0x72, 0x20, 0x66, 0x6F, 0x72, 0x20, 0x74, 0x68, 0x65, 0x20, 0x45,
	0x50, 0x43, 0x20, 0x63, 0x6F, 0x6E, 0x6E, 0x65, 0x63, 0x74, 0x65, 0x64, 0x20, 0x64, 0x65, 0x70, 0x6C, 0x6F, 0x79, 0x6D,
	0x65, 0x6E, 0x74, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x05, 0x1E, 0x80, 0x4F, 0x2D, 0x43, 0x55, 0x2D, 0x55, 0x50, 0x20,
	0x4D, 0x65, 0x61, 0x73, 0x75, 0x72, 0x65, 0x6D, 0x65, 0x6E, 0x74, 0x20, 0x43, 0x6F, 0x6E, 0x74, 0x61, 0x69, 0x6E, 0x65,
	0x72, 0x20, 0x66, 0x6F, 0x72, 0x20, 0x74, 0x68, 0x65, 0x20, 0x35, 0x47, 0x43, 0x20, 0x63, 0x6F, 0x6E, 0x6E, 0x65, 0x63,
	0x74, 0x65, 0x64, 0x20, 0x64, 0x65, 0x70, 0x6C, 0x6F, 0x79, 0x6D, 0x65, 0x6E, 0x74, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01,
	0x06, 0x1E, 0x80, 0x4F, 0x2D, 0x43, 0x55, 0x2D, 0x55, 0x50, 0x20, 0x4D, 0x65, 0x61, 0x73, 0x75, 0x72, 0x65, 0x6D, 0x65,
	0x6E, 0x74, 0x20, 0x43, 0x6F, 0x6E, 0x74, 0x61, 0x69, 0x6E, 0x65, 0x72, 0x20, 0x66, 0x6F, 0x72, 0x20, 0x74, 0x68, 0x65,
	0x20, 0x45, 0x50, 0x43, 0x20, 0x63, 0x6F, 0x6E, 0x6E, 0x65, 0x63, 0x74, 0x65, 0x64, 0x20, 0x64, 0x65, 0x70, 0x6C, 0x6F,
	0x79, 0x6D, 0x65, 0x6E, 0x74, 0x01, 0x01, 0x01, 0x01}
